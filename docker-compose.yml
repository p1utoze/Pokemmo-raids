services:
  mongodb:
    image: mongo:8.0
    container_name: pokemmo-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_USERNAME:-pokemmo}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_PASSWORD:-pokemmo_local_dev}
      MONGO_INITDB_DATABASE: pokemmo_raids
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    ports:
      - "27017:27017"
    networks:
      - pokemmo-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  raidbook:
    image: ghcr.io/p1utoze/${IMAGE_NAME:-pokemmoraids}:${LATEST_TAG:-latest}
    container_name: pokemmo-raidbook
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      MONGO_URI: "mongodb://${MONGO_INITDB_USERNAME:-pokemmo}:${MONGO_INITDB_PASSWORD:-pokemmo_local_dev}@mongodb:27017/?authSource=admin"
      MONGO_DB: ${MONGO_DB:-pokemmo_raids}
      ADMIN_DB: "${ADMIN_DB:-/app/db/users.db}"
      DATA_PATH: "${DATA_PATH:-/app/data/bosses.json}"
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:-adminpass}"
      ADMIN_SECRET: "${ADMIN_SECRET:-devsecret}"
      GIT_COMMIT_HASH: "${GIT_COMMIT_HASH:-dev}"
      # SMTP Configuration for password reset emails
      SMTP_HOST: "${SMTP_HOST}"           # e.g., smtp.gmail.com
      SMTP_PORT: "${SMTP_PORT:-587}"      # Usually 587 for TLS
      SMTP_USER: "${SMTP_USER}"           # Your email address
      SMTP_PASSWORD: "${SMTP_PASSWORD}"   # App password (not regular password)
      SMTP_FROM: "${SMTP_FROM}"           # From email address (can be same as SMTP_USER)
    volumes:
      - ./data:/app/data
      - admindb_data:/app/db
    networks:
      - pokemmo-network
    depends_on:
      mongodb:
        condition: service_healthy

  nginx:
    image: nginx:alpine
    container_name: pokemmo-nginx
    restart: unless-stopped
    ports:
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/certs:/etc/nginx/certs:ro
    depends_on:
      - raidbook
    networks:
      - pokemmo-network

volumes:
  mongodb_data:
  mongodb_config:
  admindb_data:

networks:
  pokemmo-network:
    driver: bridge